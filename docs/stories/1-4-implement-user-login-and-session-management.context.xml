<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>4</storyId>
    <title>Implement User Login and Session Management</title>
    <status>drafted</status>
    <generatedAt>2025-11-06</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-4-implement-user-login-and-session-management.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a registered user</asA>
    <iWant>to log in with my credentials and have my session maintained</iWant>
    <soThat>I can access personalized features without repeated authentication</soThat>
    <tasks>
      - Task 1: Create login page UI (AC: #1, #2)
      - Task 2: Enhance NextAuth configuration for login (AC: #1, #2)
      - Task 3: Implement session persistence (AC: #3)
      - Task 4: Create Zustand auth store for client state (AC: #3)
      - Task 5: Implement route protection with middleware (AC: #4)
      - Task 6: Implement logout functionality (AC: #5)
      - Task 7: Implement error handling (AC: #2)
      - Task 8: Testing (All ACs)
    </tasks>
  </story>

  <acceptanceCriteria>
    1. Given a user with valid credentials, when they submit the login form, then a secure session is created using NextAuth.js
    2. And invalid credentials show appropriate error messages
    3. And session persists across page refreshes
    4. And protected routes redirect to login when unauthenticated
    5. And logout functionality clears the session completely
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Authentication &amp; Authorization</section>
        <snippet>NextAuth.js with JWT sessions, password hashing with bcrypt (12 rounds), session expiry 30 days. Rate limiting on auth endpoints (5 attempts/minute). API routes require authentication except public clips list.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Technology Stack</section>
        <snippet>NextAuth.js 4.24.13 for authentication, battle-tested with Prisma integration. Project uses TypeScript 5.x for type safety and Tailwind CSS 3.4.x for styling.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>API Contracts</section>
        <snippet>Error codes follow DOMAIN_ACTION_ERROR format (e.g., AUTH_LOGIN_FAILED). API responses include success boolean and either data or error object with code and message.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 1: Project Foundation &amp; Authentication</title>
        <section>Story 1.4: Implement User Login and Session Management</section>
        <snippet>User login with credential verification, session persistence across page refreshes, protected route redirection for unauthenticated users, and logout functionality. Prerequisites: Story 1.3 (user registration).</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>FR9: User Accounts</section>
        <snippet>User accounts requirement mapped to Stories 1.3 and 1.4. Authentication state managed via session or JWT for logged-in users to access personalized features.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>apps/web/src/app/api/auth/[...nextauth]/route.ts</path>
        <kind>api-route</kind>
        <symbol>authOptions</symbol>
        <lines>1-94</lines>
        <reason>NextAuth configuration already has authorize callback implemented with credential validation, user lookup, and password verification. JWT and session callbacks are also configured. This file needs to be referenced, not recreated.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/lib/auth/password.ts</path>
        <kind>utility</kind>
        <symbol>verifyPassword</symbol>
        <lines>18-23</lines>
        <reason>Password verification function using bcrypt.compare(). Already implemented and used in NextAuth authorize callback. Reuse for login authentication.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/lib/validation/auth.schema.ts</path>
        <kind>validation</kind>
        <symbol>loginSchema</symbol>
        <lines>24-33</lines>
        <reason>Login validation schema already exists with email and password validation. Already used in NextAuth authorize callback. Can be reused for client-side validation.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/lib/prisma.ts</path>
        <kind>database</kind>
        <symbol>prisma</symbol>
        <lines>1-22</lines>
        <reason>Prisma client singleton for database queries. Already used for user lookup in authorize callback. Reuse for all database operations.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/components/auth/SignupForm.tsx</path>
        <kind>component</kind>
        <symbol>SignupForm</symbol>
        <lines>1-117</lines>
        <reason>Reference implementation for form component pattern. Shows React Hook Form + Zod integration, error handling, and loading states. Use as template for LoginForm.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/types/next-auth.d.ts</path>
        <kind>types</kind>
        <symbol>Session, User, JWT</symbol>
        <lines>1-24</lines>
        <reason>TypeScript type extensions for NextAuth. Defines session structure with user id and email. Required for type-safe NextAuth usage.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="next-auth" version="4.24.13" />
        <package name="react-hook-form" version="^7.66.0" />
        <package name="@hookform/resolvers" version="^5.2.2" />
        <package name="zod" version="^4.1.12" />
        <package name="zustand" version="^5.0.8" />
        <package name="bcryptjs" version="^3.0.3" />
        <package name="@types/bcryptjs" version="^3.0.0" />
        <package name="next" version="16.0.1" />
        <package name="react" version="19.2.0" />
        <package name="react-dom" version="19.2.0" />
        <package name="typescript" version="^5" />
        <package name="tailwindcss" version="^4" />
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    - NextAuth.js 4.24.13 with credentials provider (already configured in route.ts)
    - JWT session strategy with 30-day expiry (already configured)
    - Password verification using bcrypt via verifyPassword() utility (already implemented)
    - Zod validation schemas for client and server (loginSchema already exists)
    - React Hook Form for form state management (pattern established in SignupForm)
    - Middleware-based route protection required for protected pages
    - Error codes must follow AUTH_* pattern: AUTH_INVALID_CREDENTIALS, AUTH_USER_NOT_FOUND, AUTH_SESSION_EXPIRED
    - Protected routes: /dashboard/*, /learn/*, /flashcards/*
    - Public routes: /, /login, /signup, /api/auth/*
    - Session data structure: { user: { id, email } }
    - User database model uses snake_case: password_hash, created_at, updated_at
    - Rate limiting consideration for future: 5 attempts/minute per architecture
  </constraints>
  <interfaces>
    <interface>
      <name>NextAuth authorize callback</name>
      <kind>function-signature</kind>
      <signature>async authorize(credentials): Promise&lt;User | null&gt;</signature>
      <path>apps/web/src/app/api/auth/[...nextauth]/route.ts</path>
    </interface>
    <interface>
      <name>NextAuth session callback</name>
      <kind>function-signature</kind>
      <signature>async session({ session, token }): Promise&lt;Session&gt;</signature>
      <path>apps/web/src/app/api/auth/[...nextauth]/route.ts</path>
    </interface>
    <interface>
      <name>NextAuth JWT callback</name>
      <kind>function-signature</kind>
      <signature>async jwt({ token, user }): Promise&lt;JWT&gt;</signature>
      <path>apps/web/src/app/api/auth/[...nextauth]/route.ts</path>
    </interface>
    <interface>
      <name>useSession hook</name>
      <kind>react-hook</kind>
      <signature>useSession(): { data: Session | null, status: 'loading' | 'authenticated' | 'unauthenticated' }</signature>
      <path>next-auth/react</path>
    </interface>
    <interface>
      <name>signIn function</name>
      <kind>function</kind>
      <signature>signIn(provider: 'credentials', options: { email, password, redirect?, callbackUrl? })</signature>
      <path>next-auth/react</path>
    </interface>
    <interface>
      <name>signOut function</name>
      <kind>function</kind>
      <signature>signOut(options?: { redirect?, callbackUrl? })</signature>
      <path>next-auth/react</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      Framework: Vitest with @testing-library/react for component testing. Test environment: Node with globals enabled. Setup file at tests/setup.ts. Coverage tracking with v8 provider. Mock NextAuth and Prisma for isolated unit tests. Use @testing-library/jest-dom matchers for DOM assertions.
    </standards>
    <locations>
      - tests/ - Root test directory
      - apps/web/src/**/*.test.ts(x) - Co-located component/unit tests
      - tests/integration/ - Integration tests
      - tests/e2e/ - Playwright E2E tests
    </locations>
    <ideas>
      <test ac="1" type="unit">
        - Test loginSchema validation with valid and invalid inputs
        - Test password verification function with correct/incorrect passwords
        - Test NextAuth authorize callback with valid credentials returns user object
        - Mock Prisma user.findUnique and bcrypt.compare
      </test>
      <test ac="1,2" type="integration">
        - Test authorize callback flow: validation → user lookup → password verification
        - Test authorize callback returns null for invalid email format
        - Test authorize callback returns null for non-existent user
        - Test authorize callback returns null for incorrect password
      </test>
      <test ac="1" type="e2e">
        - Test complete login flow: fill form → submit → redirect to dashboard
        - Verify user can access protected route after login
      </test>
      <test ac="2" type="unit">
        - Test LoginForm displays validation errors for empty fields
        - Test LoginForm displays server error for AUTH_INVALID_CREDENTIALS
        - Test LoginForm displays server error for AUTH_USER_NOT_FOUND
      </test>
      <test ac="3" type="integration">
        - Test JWT callback adds user data to token on sign in
        - Test session callback adds user data from token to session
        - Mock NextAuth callbacks and verify session structure
      </test>
      <test ac="3" type="e2e">
        - Test session persists after page refresh in browser
        - Test useSession hook returns authenticated status after login
      </test>
      <test ac="4" type="integration">
        - Test middleware redirects unauthenticated users to /login
        - Test middleware allows authenticated users to access protected routes
        - Test middleware preserves intended destination URL for post-login redirect
      </test>
      <test ac="5" type="unit">
        - Test Zustand auth store clearUser action removes user data
        - Mock signOut function and verify it's called with correct options
      </test>
      <test ac="5" type="e2e">
        - Test logout button click clears session and redirects to login
        - Verify user cannot access protected route after logout
      </test>
    </ideas>
  </tests>
</story-context>
