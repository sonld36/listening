<story-context id="2-3-implement-video-player-with-controls" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>3</storyId>
    <title>Implement Video Player with Controls</title>
    <status>drafted</status>
    <generatedAt>2025-11-08</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-3-implement-video-player-with-controls.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>logged-in user</asA>
    <iWant>to watch 10-second video clips with playback controls</iWant>
    <soThat>I can listen to the dialogue multiple times before attempting dictation</soThat>
    <tasks>
      <task id="1" acs="1">
        <description>Create learning interface page with clip routing</description>
        <subtasks>
          <subtask>Create /app/(app)/learn/[clipId]/page.tsx route</subtask>
          <subtask>Implement route params handling for clipId</subtask>
          <subtask>Add loading states and error boundaries</subtask>
          <subtask>Protect route with authentication middleware</subtask>
          <subtask>Add responsive layout component</subtask>
        </subtasks>
      </task>
      <task id="2" acs="1,2,3,4,5,6">
        <description>Implement VideoPlayer component with react-player</description>
        <subtasks>
          <subtask>Install react-player: pnpm add react-player</subtask>
          <subtask>Create components/video/VideoPlayer.tsx component</subtask>
          <subtask>Integrate useClip(id) hook from Story 2.2 to fetch clip data</subtask>
          <subtask>Configure react-player with R2 CDN URL from clip data</subtask>
          <subtask>Add loading state while clip data loads</subtask>
          <subtask>Add error state for failed clip loads or missing clips</subtask>
        </subtasks>
      </task>
      <task id="3" acs="2,3,4">
        <description>Implement custom video controls</description>
        <subtasks>
          <subtask>Create components/video/VideoControls.tsx component</subtask>
          <subtask>Implement play/pause button with state management</subtask>
          <subtask>Implement replay button (reset currentTime to 0)</subtask>
          <subtask>Implement volume control slider (0-100%)</subtask>
          <subtask>Add keyboard shortcuts (Space for play/pause, R for replay)</subtask>
          <subtask>Style controls with Tailwind CSS for consistency</subtask>
          <subtask>Ensure controls overlay video player</subtask>
        </subtasks>
      </task>
      <task id="4" acs="5,6">
        <description>Optimize for performance and responsiveness</description>
        <subtasks>
          <subtask>Configure react-player for optimal buffering and preload settings</subtask>
          <subtask>Implement responsive container with aspect ratio preservation</subtask>
          <subtask>Test video loading from Cloudflare R2 CDN</subtask>
          <subtask>Add lazy loading for VideoPlayer component</subtask>
          <subtask>Optimize for mobile viewports (portrait and landscape)</subtask>
          <subtask>Test on different screen sizes and devices</subtask>
        </subtasks>
      </task>
      <task id="5" acs="1,2,3,4,5,6">
        <description>Testing</description>
        <subtasks>
          <subtask>Unit test: VideoPlayer component rendering and props</subtask>
          <subtask>Unit test: VideoControls button interactions</subtask>
          <subtask>Integration test: Video playback state management</subtask>
          <subtask>Integration test: Clip data loading with useClip hook</subtask>
          <subtask>E2E test: Complete learning interface flow (select clip → watch → controls work)</subtask>
          <subtask>Test error scenarios: invalid clipId, network failure, CDN unavailable</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1">
      <given>a user selects a clip from the dashboard</given>
      <when>the learning interface loads</when>
      <then>the video player displays with the selected clip</then>
    </ac>
    <ac id="2">
      <description>play/pause button works correctly</description>
    </ac>
    <ac id="3">
      <description>replay button restarts the video from beginning</description>
    </ac>
    <ac id="4">
      <description>volume control is available</description>
    </ac>
    <ac id="5">
      <description>video loads from CDN without buffering issues</description>
    </ac>
    <ac id="6">
      <description>player is responsive on mobile and desktop</description>
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.3: Implement Video Player with Controls</section>
        <snippet>Acceptance Criteria: Given a user selects a clip from the dashboard, when the learning interface loads, then the video player displays with the selected clip. And play/pause button works correctly. And replay button restarts the video from beginning. And volume control is available. Technical Notes: Use react-player library, implement custom controls for consistent UI, add loading states and error handling.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Component Patterns</section>
        <snippet>Component File Organization: Components in PascalCase (VideoPlayer.tsx), Folders in kebab-case (video-player/), Tests co-located (VideoPlayer.test.tsx). Component Structure: Export interfaces for props, use destructuring with typed parameters.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>Technology Stack Details</section>
        <snippet>Frontend: Next.js 15 with App Router for server-side rendering, React 19 for UI components with Server Components support, react-player for video playback with custom controls. State Management: TanStack Query v5 for server state (data fetching, caching).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document</title>
        <section>API Contracts</section>
        <snippet>Clips: GET /api/clips returns paginated list with clips array and total count. Video URL Format: Clips stored in Cloudflare R2 with CDN delivery, 10-second duration constraint enforced server-side.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Story 1.3: Duyệt và Phát Bộ sưu tập Video (FR1, FR2)</section>
        <snippet>As a logged-in user, I want to see a collection of video clips on my dashboard and play one, so that I can select a clip to start my dictation practice. Giao diện Học tập hiển thị một trình phát video (FR2). Clip video 10 giây được phát chính xác.</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-2-create-video-clip-management-api.md</path>
        <title>Story 2.2 - Create Video Clip Management API</title>
        <section>Dev Agent Record</section>
        <snippet>Frontend infrastructure complete: useClip(id) hook ready to use for fetching clip data by ID. IClip interface includes clipUrl (R2 CDN URL to use in react-player), durationSeconds (always 10), difficultyLevel, subtitleText. TanStack Query Hook Usage Pattern provided for loading/error states.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>apps/web/src/hooks/useClips.ts</path>
        <kind>hook</kind>
        <symbol>useClip</symbol>
        <lines>158-176</lines>
        <reason>Hook for fetching single video clip by ID - must be used to load clip data in VideoPlayer component. Returns { clip, isLoading, isError, error, refetch } with automatic caching and background refetch.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/types/api.ts</path>
        <kind>types</kind>
        <symbol>IClip</symbol>
        <lines>31-42</lines>
        <reason>TypeScript interface defining clip data structure including clipUrl (R2 CDN URL), title, durationSeconds (10), difficultyLevel, subtitleText, difficultyWords. Use this interface for type safety in VideoPlayer props.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/services/clips.service.ts</path>
        <kind>service</kind>
        <symbol>fetchClipById</symbol>
        <lines>141-177</lines>
        <reason>Service layer function for fetching clip by ID with error handling. Already wrapped by useClip hook, reference for error handling patterns (ApiError class with code/message/details).</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/app/(app)/dashboard/page.tsx</path>
        <kind>page</kind>
        <symbol>DashboardPage</symbol>
        <lines>1-50</lines>
        <reason>Dashboard page where users select clips to practice. This is where navigation to learning interface (/learn/[clipId]) will originate. Follow similar authentication and layout patterns.</reason>
      </artifact>
      <artifact>
        <path>apps/web/src/components/providers/Providers.tsx</path>
        <kind>component</kind>
        <symbol>Providers</symbol>
        <lines>17-32</lines>
        <reason>TanStack Query provider configuration with QueryClient. Confirms 5-minute staleTime, background refetch on window focus, and exponential backoff retry strategy are already configured globally.</reason>
      </artifact>
    </code>

    <dependencies>
      <node>
        <package name="react-player" version="^3.3.3" status="already-installed">Video player library supporting multiple formats with customizable controls</package>
        <package name="@tanstack/react-query" version="^5.90.7" status="already-installed">Server state management for data fetching and caching</package>
        <package name="next" version="16.0.1" status="already-installed">Next.js framework with App Router support</package>
        <package name="react" version="19.2.0" status="already-installed">React library with Server Components</package>
        <package name="tailwindcss" version="^4" status="already-installed">Utility-first CSS framework for styling controls</package>
        <package name="zod" version="^4.1.12" status="already-installed">TypeScript-first validation library (may use for route params validation)</package>
        <package name="@testing-library/react" version="^16.3.0" status="dev-dependency">Testing library for React components</package>
        <package name="vitest" version="^2.1.8" status="dev-dependency">Unit testing framework</package>
        <package name="@playwright/test" version="^1.49.1" status="dev-dependency">E2E testing framework</package>
      </node>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint category="architecture">
      <rule>Use Next.js App Router with route params pattern: /app/(app)/learn/[clipId]/page.tsx</rule>
      <source>docs/architecture.md#Project-Structure</source>
    </constraint>
    <constraint category="architecture">
      <rule>Protected routes under (app) group require authentication - use NextAuth session checking</rule>
      <source>docs/architecture.md#Security-Architecture</source>
    </constraint>
    <constraint category="components">
      <rule>Components must follow PascalCase naming (VideoPlayer.tsx, VideoControls.tsx)</rule>
      <source>docs/architecture.md#Component-Patterns</source>
    </constraint>
    <constraint category="components">
      <rule>Component folders use kebab-case (components/video/)</rule>
      <source>docs/architecture.md#Component-Patterns</source>
    </constraint>
    <constraint category="styling">
      <rule>Use Tailwind CSS utility classes for all styling - no custom CSS files</rule>
      <source>docs/architecture.md#Technology-Stack-Details</source>
    </constraint>
    <constraint category="state-management">
      <rule>Use TanStack Query (via useClip hook) for server state - DO NOT recreate data fetching logic</rule>
      <source>docs/architecture.md#State-Management and docs/stories/2-2-create-video-clip-management-api.md#Learnings</source>
    </constraint>
    <constraint category="video">
      <rule>react-player must be configured with controls={false} - use custom controls only</rule>
      <source>docs/stories/2-3-implement-video-player-with-controls.md#Dev-Notes</source>
    </constraint>
    <constraint category="video">
      <rule>Video duration is always 10 seconds - no need for dynamic duration handling</rule>
      <source>docs/architecture.md#API-Contracts and docs/epics.md#Story-2.3</source>
    </constraint>
    <constraint category="testing">
      <rule>Unit tests with Vitest, integration tests with React Testing Library, E2E tests with Playwright</rule>
      <source>docs/architecture.md#Deployment-Architecture</source>
    </constraint>
    <constraint category="testing">
      <rule>Maintain 100% test coverage standard from Story 2.2 (27/27 tests passing)</rule>
      <source>docs/stories/2-2-create-video-clip-management-api.md#Learnings</source>
    </constraint>
    <constraint category="responsive">
      <rule>Player must be responsive on mobile and desktop - test both portrait and landscape orientations</rule>
      <source>docs/stories/2-3-implement-video-player-with-controls.md#AC-6</source>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>useClip(id: string, options?: { enabled?: boolean })</name>
      <kind>React Hook (TanStack Query)</kind>
      <signature>
        function useClip(id: string, options?: { enabled?: boolean }): {
          clip: IClip | undefined;
          isLoading: boolean;
          isError: boolean;
          error: Error | null;
          refetch: () => void;
        }
      </signature>
      <path>apps/web/src/hooks/useClips.ts:158-176</path>
      <usage>Import and call in VideoPlayer component to fetch clip data by clipId from route params. Handle loading/error states before rendering player.</usage>
    </interface>

    <interface>
      <name>IClip</name>
      <kind>TypeScript Interface</kind>
      <signature>
        interface IClip {
          id: string;
          title: string;
          description?: string;
          clipUrl: string;          // R2 public CDN URL - pass to react-player url prop
          durationSeconds: number;   // Always 10
          difficultyLevel: 'BEGINNER' | 'INTERMEDIATE' | 'ADVANCED';
          subtitleText: string;      // Full transcript (for future stories)
          difficultyWords?: object;  // JSON array of challenging words (for Story 3.1)
          createdAt: Date;
          updatedAt: Date;
        }
      </signature>
      <path>apps/web/src/types/api.ts:31-42</path>
      <usage>Use for type safety in VideoPlayer component props. clip.clipUrl is the R2 CDN URL to pass to react-player.</usage>
    </interface>

    <interface>
      <name>ReactPlayer</name>
      <kind>React Component (react-player library)</kind>
      <signature>
        &lt;ReactPlayer
          url={string}           // Required: Video URL (use clip.clipUrl)
          playing={boolean}      // Controlled play state
          volume={number}        // 0-1 (convert from 0-100%)
          controls={boolean}     // MUST be false for custom controls
          width={string}         // "100%" for responsive
          height={string}        // "100%" for responsive
          onReady={() => void}   // Loading complete callback
          onError={(e) => void}  // Error handling callback
          config={{
            file: {
              attributes: {
                controlsList: 'nodownload',
                preload: 'metadata'
              }
            }
          }}
        /&gt;
      </signature>
      <path>node_modules/react-player (external library)</path>
      <usage>Main video player component. Import from 'react-player'. Configure with clip.clipUrl and custom controls state.</usage>
    </interface>

    <interface>
      <name>Next.js Route Params (App Router)</name>
      <kind>Next.js Pattern</kind>
      <signature>
        // page.tsx in /app/(app)/learn/[clipId]/
        export default function LearnPage({
          params,
        }: {
          params: { clipId: string };
        }) {
          const clipId = params.clipId;
          // Use clipId with useClip(clipId) hook
        }
      </signature>
      <path>apps/web/src/app/(app)/learn/[clipId]/page.tsx (to be created)</path>
      <usage>Extract clipId from route params and pass to useClip hook. Handle async params in Next.js 15+ if needed.</usage>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Unit tests use Vitest with React Testing Library for component isolation. Integration tests use React Query test utilities with custom QueryClient wrapper for hook behavior validation. E2E tests use Playwright for complete user flows. Follow AAA pattern (Arrange, Act, Assert). Mock external dependencies (react-player, fetch API). Achieve comprehensive coverage like Story 2.2 (27/27 tests passing).
    </standards>

    <locations>
      - Unit tests: tests/unit/components/video/
      - Integration tests: apps/web/tests/integration/hooks/ and apps/web/tests/integration/pages/
      - E2E tests: tests/e2e/ or apps/web/tests/e2e/
    </locations>

    <ideas>
      <idea ac="1">
        <test>Unit: VideoPlayer component renders with valid clip URL from useClip hook</test>
        <test>Integration: Learning page route with valid clipId loads clip data and renders player</test>
        <test>E2E: User clicks clip on dashboard, navigates to /learn/[clipId], sees video player</test>
      </idea>
      <idea ac="2">
        <test>Unit: Play/pause button toggles playing state correctly</test>
        <test>Integration: Play button starts video, pause button stops video</test>
        <test>E2E: User clicks play, video starts; clicks pause, video stops</test>
      </idea>
      <idea ac="3">
        <test>Unit: Replay button resets currentTime to 0</test>
        <test>Integration: Replay button calls react-player seekTo(0) method</test>
        <test>E2E: User watches video partially, clicks replay, video restarts from beginning</test>
      </idea>
      <idea ac="4">
        <test>Unit: Volume control slider updates volume state (0-100%)</test>
        <test>Integration: Volume slider changes react-player volume prop (converted to 0-1 range)</test>
        <test>E2E: User adjusts volume slider, video volume changes accordingly</test>
      </idea>
      <idea ac="5">
        <test>Unit: react-player configured with preload="metadata" and proper CDN URL</test>
        <test>Integration: Video loads from Cloudflare R2 CDN URL (mock successful load)</test>
        <test>E2E: Video loads without buffering issues (test with sample R2 clip)</test>
      </idea>
      <idea ac="6">
        <test>Unit: VideoPlayer component has responsive container with aspect ratio</test>
        <test>Integration: Component renders correctly at mobile (320px) and desktop (1920px) viewports</test>
        <test>E2E: Test responsive behavior on mobile portrait, mobile landscape, tablet, desktop</test>
      </idea>
      <idea ac="error-handling">
        <test>Unit: VideoPlayer shows error state when useClip returns isError=true</test>
        <test>Integration: Invalid clipId shows 404 error message</test>
        <test>E2E: Navigate to /learn/invalid-id, see "Clip not found" error</test>
      </idea>
      <idea ac="loading">
        <test>Unit: VideoPlayer shows loading spinner when useClip isLoading=true</test>
        <test>Integration: Loading state displayed while fetching clip data</test>
        <test>E2E: Page shows loading indicator before video appears</test>
      </idea>
    </ideas>
  </tests>
</story-context>
